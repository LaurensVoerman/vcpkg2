#vcpkg_check_linkage(ONLY_DYNAMIC_LIBRARY)
vcpkg_cmake_get_vars(cmake_vars_file)
include("${cmake_vars_file}")
# needs cmake_vars_file for VCPKG_DETECTED_MSVC_VERSION 1944

if(VCPKG_TARGET_IS_WINDOWS)
	if(VCPKG_TARGET_IS_UWP)
		IF(VCPKG_DETECTED_MSVC_VERSION GREATER_EQUAL 1930 AND VCPKG_DETECTED_MSVC_VERSION LESS 1950)
			SET(FBX_LIBDIR "vs2022")
			vcpkg_download_distfile(ARCHIVE
				URLS "https://damassets.autodesk.net/content/dam/autodesk/www/files/fbx202037_fbxsdk_${FBX_LIBDIR}_winstore_win.exe"
				FILENAME "fbx202037_fbxsdk_${FBX_LIBDIR}_win.exe"
				SHA512 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000)
		ELSEIF(VCPKG_DETECTED_MSVC_VERSION GREATER_EQUAL 1920 AND VCPKG_DETECTED_MSVC_VERSION LESS 1930)
			SET(FBX_LIBDIR "vs2019")
			vcpkg_download_distfile(ARCHIVE
				URLS "https://damassets.autodesk.net/content/dam/autodesk/www/files/fbx202037_fbxsdk_${FBX_LIBDIR}_winstore_win.exe"
				FILENAME "fbx202037_fbxsdk_${FBX_LIBDIR}_win.exe"
				SHA512 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000)
		ELSEIF(VCPKG_DETECTED_MSVC_VERSION GREATER_EQUAL 1910 AND VCPKG_DETECTED_MSVC_VERSION LESS 1920)
			SET(FBX_LIBDIR "vs2017")
			vcpkg_download_distfile(ARCHIVE
				URLS "https://damassets.autodesk.net/content/dam/autodesk/www/files/fbx202037_fbxsdk_${FBX_LIBDIR}_winstore_win.exe"
				FILENAME "fbx202037_fbxsdk_${FBX_LIBDIR}_win.exe"
				SHA512 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000)
		ENDIF()
		message( FATAL_ERROR "fbx not tested with UWP ")
	elseif(VCPKG_TARGET_IS_MINGW)
		message( FATAL_ERROR "fbx not tested with MINGW")
	else()
		message("windows !uwp !mingw VCPKG_DETECTED_MSVC_VERSION ${VCPKG_DETECTED_MSVC_VERSION} VCPKG_PLATFORM_TOOLSET ${VCPKG_PLATFORM_TOOLSET}")
		IF(VCPKG_DETECTED_MSVC_VERSION GREATER_EQUAL 1930 AND VCPKG_DETECTED_MSVC_VERSION LESS 1950)
			SET(FBX_LIBDIR "vs2022")
			vcpkg_download_distfile(ARCHIVE
				URLS "https://damassets.autodesk.net/content/dam/autodesk/www/files/fbx202037_fbxsdk_${FBX_LIBDIR}_win.exe"
				FILENAME "fbx202037_fbxsdk_${FBX_LIBDIR}_win.exe"
				SHA512 2f3daf41a7c3a247046291aaf8a21663aa89d64b10fe386a6fa082d799abe840e9d1fbee4ea3f902c4e59010e21e6149132c9b0a8f2c5eca0a1a723e9a25fd16)
		ELSEIF(VCPKG_DETECTED_MSVC_VERSION GREATER_EQUAL 1920 AND VCPKG_DETECTED_MSVC_VERSION LESS 1930)
			SET(FBX_LIBDIR "vs2019")
			vcpkg_download_distfile(ARCHIVE
				URLS "https://damassets.autodesk.net/content/dam/autodesk/www/files/fbx202037_fbxsdk_${FBX_LIBDIR}_win.exe"
				FILENAME "fbx202037_fbxsdk_${FBX_LIBDIR}_win.exe"
				SHA512 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000)
		ELSEIF(VCPKG_DETECTED_MSVC_VERSION GREATER_EQUAL 1910 AND VCPKG_DETECTED_MSVC_VERSION LESS 1920)
			SET(FBX_LIBDIR "vs2017")
			vcpkg_download_distfile(ARCHIVE
				URLS "https://damassets.autodesk.net/content/dam/autodesk/www/files/fbx202037_fbxsdk_${FBX_LIBDIR}_win.exe"
				FILENAME "fbx202037_fbxsdk_${FBX_LIBDIR}_win.exe"
				SHA512 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000)
		ENDIF()
	endif()
elseif(VCPKG_TARGET_IS_LINUX)
    vcpkg_download_distfile(ARCHIVE
        URLS "https://damassets.autodesk.net/content/dam/autodesk/www/files/fbx202037_fbxsdk_gcc_linux.tar.gz"
        FILENAME "fbx202037_fbxsdk_gcc_linux.tar.gz"
        SHA512 c2076ab34c4afe541f503643ea18e737cdb045973cc60811916feddeb75f7945d22b5537c40471c80cc1b0fb623556517d5c33e139e55e724701f7619a196cdb)
	message( FATAL_ERROR "fbx not tested ever on LINUX")
elseif(VCPKG_TARGET_IS_OSX)
    vcpkg_download_distfile(ARCHIVE
        URLS "https://damassets.autodesk.net/content/dam/autodesk/www/files/fbx202037_fbxsdk_clang_mac.pkg.tgz"
        FILENAME "fbx202037_fbxsdk_clang_mac.pkg.tgz"
        SHA512 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000)
	message( FATAL_ERROR "fbx not tested ever on OSX")
elseif(VCPKG_TARGET_IS_IOS)
    vcpkg_download_distfile(ARCHIVE
        URLS "https://damassets.autodesk.net/content/dam/autodesk/www/files/fbx202037_fbxsdk_ios_mac.pkg.tgz"
        FILENAME "fbx202037_fbxsdk_ios_mac.pkg.tgz"
        SHA512 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000)
	message( FATAL_ERROR "fbx not tested ever on IOS")
endif()

#vcpkg_extract_source_archive_ex(
#    OUT_SOURCE_PATH SOURCE_PATH
#    ARCHIVE "${ARCHIVE}"
#)
set(SOURCE_PATH "${CURRENT_BUILDTREES_DIR}/src")
if(NOT IS_DIRECTORY "${SOURCE_PATH}")
  vcpkg_extract_archive(
  	ARCHIVE "${ARCHIVE}"
  	DESTINATION "${SOURCE_PATH}"
  )
endif()
set(VCPKG_POLICY_EMPTY_INCLUDE_FOLDER enabled)

#file(GLOB_RECURSE headers LIST_DIRECTORIES true "${SOURCE_PATH}/include/*")
#file(COPY ${headers} DESTINATION "${CURRENT_PACKAGES_DIR}/FBX/${VERSION}/include")

#error: install command is not scriptable
#install(DIRECTORY "${SOURCE_PATH}/include" DESTINATION "${CURRENT_PACKAGES_DIR}/FBX/${VERSION}/include")

#file(COPY "${SOURCE_PATH}/include" DESTINATION "${CURRENT_PACKAGES_DIR}/FBX/${VERSION}" FILES_MATCHING PATTERN "*.h")

#confict on include/libxml2/libxml/
#file(COPY "${SOURCE_PATH}/include" DESTINATION "${CURRENT_PACKAGES_DIR}" FILES_MATCHING PATTERN "*.h")

#skip libxml2 something wrong on next line: fbxsdk folder and subfolders empty
#file(COPY "${SOURCE_PATH}/include/fbxsdk" DESTINATION "${CURRENT_PACKAGES_DIR}/fbxsdk/" FILES_MATCHING PATTERN "*.h")
#file(COPY "${SOURCE_PATH}/include" DESTINATION "${CURRENT_PACKAGES_DIR}" FILES_MATCHING PATTERN "fbxsdk.h")

file(REMOVE_RECURSE "${SOURCE_PATH}/include/libxml2")
file(COPY "${SOURCE_PATH}/include" DESTINATION "${CURRENT_PACKAGES_DIR}" FILES_MATCHING PATTERN "*.h")

if(VCPKG_TARGET_IS_WINDOWS)
	#set(FBX_INSTLIBDIR_REL /FBX/${VERSION}/${FBX_LIBDIR}/${VCPKG_TARGET_ARCHITECTURE}/release/)
	#set(FBX_INSTLIBDIR_DBG /FBX/${VERSION}/${FBX_LIBDIR}/${VCPKG_TARGET_ARCHITECTURE}/debug/)
	set(FBX_INSTLIBDIR_REL /lib/)
	set(FBX_INSTLIBDIR_DBG /debug/lib/)
	set(FBX_INSTDLLDIR_REL /bin/)
	set(FBX_INSTDLLDIR_DBG /debug/bin/)
	IF("${VCPKG_LIBRARY_LINKAGE}" STREQUAL "static")
    file(COPY "${SOURCE_PATH}/lib/${VCPKG_TARGET_ARCHITECTURE}/debug/alembic-md.lib" DESTINATION "${CURRENT_PACKAGES_DIR}${FBX_INSTLIBDIR_DBG}")
    file(COPY "${SOURCE_PATH}/lib/${VCPKG_TARGET_ARCHITECTURE}/debug/libfbxsdk-md.lib" DESTINATION "${CURRENT_PACKAGES_DIR}${FBX_INSTLIBDIR_DBG}")
    file(COPY "${SOURCE_PATH}/lib/${VCPKG_TARGET_ARCHITECTURE}/debug/libxml2-md.lib" DESTINATION "${CURRENT_PACKAGES_DIR}${FBX_INSTLIBDIR_DBG}")
    file(COPY "${SOURCE_PATH}/lib/${VCPKG_TARGET_ARCHITECTURE}/debug/zlib-md.lib" DESTINATION "${CURRENT_PACKAGES_DIR}${FBX_INSTLIBDIR_DBG}")
    file(COPY "${SOURCE_PATH}/lib/${VCPKG_TARGET_ARCHITECTURE}/release/alembic-md.lib" DESTINATION "${CURRENT_PACKAGES_DIR}${FBX_INSTLIBDIR_REL}")
    file(COPY "${SOURCE_PATH}/lib/${VCPKG_TARGET_ARCHITECTURE}/release/libfbxsdk-md.lib" DESTINATION "${CURRENT_PACKAGES_DIR}${FBX_INSTLIBDIR_REL}")
    file(COPY "${SOURCE_PATH}/lib/${VCPKG_TARGET_ARCHITECTURE}/release/libxml2-md.lib" DESTINATION "${CURRENT_PACKAGES_DIR}${FBX_INSTLIBDIR_REL}")
    file(COPY "${SOURCE_PATH}/lib/${VCPKG_TARGET_ARCHITECTURE}/release/zlib-md.lib" DESTINATION "${CURRENT_PACKAGES_DIR}${FBX_INSTLIBDIR_REL}")
	ELSE("${VCPKG_LIBRARY_LINKAGE}" STREQUAL "static")
	file(COPY "${SOURCE_PATH}/lib/${VCPKG_TARGET_ARCHITECTURE}/release/libfbxsdk.lib" DESTINATION "${CURRENT_PACKAGES_DIR}${FBX_INSTLIBDIR_REL}")
	file(COPY "${SOURCE_PATH}/lib/${VCPKG_TARGET_ARCHITECTURE}/debug/libfbxsdk.lib" DESTINATION "${CURRENT_PACKAGES_DIR}${FBX_INSTLIBDIR_DBG}")
	file(COPY "${SOURCE_PATH}/lib/${VCPKG_TARGET_ARCHITECTURE}/release/libfbxsdk.dll" DESTINATION "${CURRENT_PACKAGES_DIR}${FBX_INSTDLLDIR_REL}")
	file(COPY "${SOURCE_PATH}/lib/${VCPKG_TARGET_ARCHITECTURE}/debug/libfbxsdk.dll" DESTINATION "${CURRENT_PACKAGES_DIR}${FBX_INSTDLLDIR_DBG}")
	ENDIF("${VCPKG_LIBRARY_LINKAGE}" STREQUAL "static")
  if(VCPKG_TARGET_ARCHITECTURE STREQUAL "x64")
    message("fbx x64 OK")
  elseif(VCPKG_TARGET_ARCHITECTURE STREQUAL "arm64")
    message("fbx arm64 untested")
  elseif(VCPKG_TARGET_ARCHITECTURE STREQUAL "x86")
    message( FATAL_ERROR "fbx x86 NOT SUPPORTED")
  else()
    message( FATAL_ERROR "fbx ${VCPKG_TARGET_ARCHITECTURE} NOT SUPPORTED")
  endif()
elseif(VCPKG_TARGET_IS_LINUX)
  if(VCPKG_TARGET_ARCHITECTURE STREQUAL "x64")
    file(COPY "${SOURCE_PATH}/lib64/libxl.so" DESTINATION "${CURRENT_PACKAGES_DIR}/lib")
    file(COPY "${SOURCE_PATH}/lib64/libxl.so" DESTINATION "${CURRENT_PACKAGES_DIR}/debug/lib")
  elseif(VCPKG_TARGET_ARCHITECTURE STREQUAL "x86")
    file(COPY "${SOURCE_PATH}/lib/libxl.so" DESTINATION "${CURRENT_PACKAGES_DIR}/lib")
    file(COPY "${SOURCE_PATH}/lib/libxl.so" DESTINATION "${CURRENT_PACKAGES_DIR}/debug/lib")
  endif()
endif()
file(INSTALL "${CMAKE_CURRENT_LIST_DIR}/vcpkg-cmake-wrapper.cmake" DESTINATION "${CURRENT_PACKAGES_DIR}/share/${PORT}")
file(INSTALL "${CMAKE_CURRENT_LIST_DIR}/usage" DESTINATION "${CURRENT_PACKAGES_DIR}/share/${PORT}")

# Handle copyright
file(INSTALL "${SOURCE_PATH}/license.rtf" DESTINATION "${CURRENT_PACKAGES_DIR}/share/${PORT}" RENAME copyright)
